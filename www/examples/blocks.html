<html>
<head>
	<title>JSGE - Blocks Game</title>
	<script src="../../build/j5g3.js"></script>
	<script src="../../src/Debug.js"></script>
<script>
function game($)
{
var
	// CONSTANTS
	BLOCK_WIDTH = 24,
	BLOCK_HEIGHT= 24,
	BLOCK_PIECES= 7,
	BLOCK_COLORS= 9,
	BOARD_WIDTH = 10,
	BOARD_HEIGHT= 15,
	PIECE_WIDTH = [2,1,2,2,2,2,2],

	// Our Spritesheet
	ss = $.spritesheet('spritesheet').grid(10,2),

	get_map = function(piece, c)
	{
		switch (piece) {
		case 0: return [[c],[c],[c,c]];
		case 1: return [[c],[c],[c],[c]];
		case 2: return [[c],[c,c],[c]];
		case 3: return [[c,c],[c,c]];
		case 4: return [[0,c],[0,c],[c,c]];
		case 5: return [[0,c],[c,c],[c]];
		case 6: return [[c],[c,c],[0,c]];
		}
	},
	// Creates a new map object based on the template and color specified
	piece = function(template, color)
	{
		var result = $.map({ sprites: ss.sprites(), map: get_map(template, color), tw: BLOCK_WIDTH, th: BLOCK_HEIGHT}); 
		return result;		
	},

	/* Gets next piece as a clip, and centers it to its origin */
	get_next = function()
	{
		var t = Math.floor(Math.random()*BLOCK_PIECES),
		    p = piece(t, Math.ceil(Math.random()*BLOCK_COLORS))
		;
		p.width(BLOCK_WIDTH*PIECE_WIDTH[t])
		 .height(BLOCK_HEIGHT*p.__map.length)
		;

		return $.clip([[ p ]]).align_children('origin');
	},

	background = $.image('background'),
	next = get_next(),
	next_box = $.clip({x: 48, y: 100}).add(next),
	board= $.clip().pos(200, 48).size(BLOCK_WIDTH*BOARD_WIDTH, BLOCK_HEIGHT*BOARD_HEIGHT),
	current,

	go_next = function() {
		board.add(current = next.remove());
		next_box.add(next = get_next());
	},

	gravity = function() {
		current.__y = (current.__y + 1);
		if (current.__y >= 400)
			go_next();
	},
	rotate = function()
	{
		$.root.add($.tween({ target: current, auto_remove: true, duration: 10, from: { rotation: current.__rotation }, to: { rotation: current.__rotation + Math.PI/2} }));
	},

	left = function()
	{
		if (current.__x > 0)
			$.root.add($.tween({ target: current, auto_remove: true, duration: 3, from: { x: current.__x }, to: { x: current.__x-BLOCK_WIDTH} }));
	},

	right = function()
	{
		if (current.__x < board.__width)
			$.root.add($.tween({ target: current, auto_remove: true, duration: 3, from: { x: current.__x }, to: { x: current.__x+BLOCK_WIDTH} }));
	},

	down = function()
	{
	},

	keyboard = function(evt) {
		switch(evt.keyCode) {
		case 38: rotate(); break;
		case 37: left(); break;
		case 39: right(); break;
		case 40: down(); break;
		}
	},
	speed = 10
;
	go_next();
	setInterval(gravity, speed);
	window.addEventListener('keyup', keyboard);

	$.background.fillStyle('#006');
	$.root.add([background, next_box, board]);
	$.run();
}
</script>
	<link rel="stylesheet" href="styles.css" />
</head>
<body onload="j5g3.start(game);">
	<h1>Blocks</h1>
	<canvas id="screen"></canvas>
	<h2>Instructions</h2>
	<div id="assets"> 
		<img id="spritesheet" src="blocks-ss.png" />
		<img id="background" src="light.png">
	</div>
</body>
