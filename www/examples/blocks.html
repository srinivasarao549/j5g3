<html>
<head>
	<title>JSGE - Blocks Game</title>
	<script src="../../build/j5g3.js"></script>
	<script src="../../src/Debug.js"></script>
<script>
function game($)
{
var
	/* CONSTANTS */
	BLOCK_WIDTH = 24,
	BLOCK_HEIGHT= 24,
	BLOCK_PIECES= 7,
	BLOCK_COLORS= 9,
	PIECE_WIDTHS = [2,1,2,2,2,2,2],
	BOARD_WIDTH = 10,
	BOARD_HEIGHT= 18,

	// Our Spritesheet
	ss = $.spritesheet('spritesheet').grid(10,2),

	/* CLASSES */
	Piece = $.Clip.extend({

		/* private */
		_get_map: function(piece, c)
		{
			switch (piece) {
			case 0: return [[c],[c],[c,c]];
			case 1: return [[c],[c],[c],[c]];
			case 2: return [[c],[c,c],[c]];
			case 3: return [[c,c],[c,c]];
			case 4: return [[0,c],[0,c],[c,c]];
			case 5: return [[0,c],[c,c],[c]];
			case 6: return [[c],[c,c],[0,c]];
			}
		},

		// Creates a new map object based on the template and color specified
		_piece: function(template, color)
		{
			var result = $.map({ sprites: ss.sprites(), map: this._get_map(template, color), tw: BLOCK_WIDTH, th: BLOCK_HEIGHT}); 
			result.width(BLOCK_WIDTH*PIECE_WIDTHS[template])
			      .height(BLOCK_HEIGHT*result.__map.length)
			;
			return result;		
		},

		/* constructor */
		init: function(properties)
		{
			var p = this._piece(properties.piece, properties.color);

			this._super(properties);
			this.add(p)
			    .size(p.width(), p.height())
			    .align_children('origin')
			;
		},

		tween: function(property, to)
		{
			if (this.__frames[0].length>1) return;

			var from = { }, _to = { };
			from[property]=this[property]();
			_to[property] = to;
			return this.add($.tween({ target: this, auto_remove: true, duration: 3, from: from, to: _to }));
		},

		rotate: function()
		{
			this.tween('rotation', this.__rotation+Math.PI/2);
		},

		left: function()
		{
			if (this.__x > 0)
				this.tween('x', this.__x-BLOCK_WIDTH);
		},

		right: function()
		{
			if (this.__x < board.__width)
				this.tween('x', this.__x+BLOCK_WIDTH);
		},
		down: function()
		{
			this.__y = (this.__y + 1);
		}
	}),

	Board = $.Clip.extend({

		init: function(properties)
		{
			var i = this.HEIGHT;

			this._super(properties);

			// Initialize Map
			this.__map = [];
			this.__sprites = ss.sprites();
			while (i--)
				this.__map.push([]);

			this.add($.map({sprites: ss.sprites(), map: this.__map, tw: BLOCK_WIDTH, th: BLOCK_HEIGHT }))
			    .size(BLOCK_WIDTH * BOARD_WIDTH, BLOCK_HEIGHT * BOARD_HEIGHT)
			;
		}
	}),

	/* Gets next piece as a clip, and centers it to its origin */
	get_next = function()
	{
		return new Piece({ 
			piece: Math.floor(Math.random()*BLOCK_PIECES), 
			color: Math.ceil(Math.random()*BLOCK_COLORS)
		});
	},

	go_next = function() {
		current = next.remove().x(Math.floor(BOARD_WIDTH/2)*BLOCK_WIDTH - next.width()/2);
		board.add(current);
		next_box.add(next = get_next());
	},

	gravity = function() {
		if (current.__y >= board.__height-current.__height/2)
			go_next();

		current.down();
	},

	keyboard = function(evt) {
		switch(evt.keyCode) {
		case 38: current.rotate(); break;
		case 37: current.left(); break;
		case 39: current.right(); break;
		case 40: current.down(); break;
		}
	},
	speed = 10,

	// Screen Element
	background = $.image('background'),
	next = get_next(),
	current,
	next_box = $.clip({x: 48, y: 100}).add(next),
	board = new Board({ x: 200, y: 48 })
;
	go_next();
	setInterval(gravity, speed);
	window.addEventListener('keyup', keyboard);

	$.background.fillStyle('#006');
	$.root.add([background, next_box, board]);
	$.run();
}
</script>
	<link rel="stylesheet" href="styles.css" />
</head>
<body onload="j5g3.start(game);">
	<h1>Blocks</h1>
	<canvas id="screen"></canvas>
	<h2>Instructions</h2>
	<div id="assets"> 
		<img id="spritesheet" src="blocks-ss.png" />
		<img id="background" src="light.png">
	</div>
</body>
